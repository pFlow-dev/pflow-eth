<html>
<head>
    <title>TicTacToe | Petri-nets in Solidity</title>
    <script crossorigin="anonymous"
            integrity="sha256-jNzSqmjGhIDVGAygzWTxkMcGT97P9ZbqNAQuul/xgds=" src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script src="https://pflow.dev/js/metamodel.js"></script>
    <script src="https://pflow.dev/demo/tictactoe/model.js"></script>
    <script src="https://pflow.dev/demo/tictactoe/controller.js"></script>
</head>
<body>
<script>
function getABI(){
    return [{"type":"constructor","stateMutability":"nonpayable","inputs":[{"type":"address","name":"p0","internalType":"address"},{"type":"address","name":"p1","internalType":"address"}]},{"type":"event","name":"RoleAdminChanged","inputs":[{"type":"bytes32","name":"role","internalType":"bytes32","indexed":true},{"type":"bytes32","name":"previousAdminRole","internalType":"bytes32","indexed":true},{"type":"bytes32","name":"newAdminRole","internalType":"bytes32","indexed":true}],"anonymous":false},{"type":"event","name":"RoleGranted","inputs":[{"type":"bytes32","name":"role","internalType":"bytes32","indexed":true},{"type":"address","name":"account","internalType":"address","indexed":true},{"type":"address","name":"sender","internalType":"address","indexed":true}],"anonymous":false},{"type":"event","name":"RoleRevoked","inputs":[{"type":"bytes32","name":"role","internalType":"bytes32","indexed":true},{"type":"address","name":"account","internalType":"address","indexed":true},{"type":"address","name":"sender","internalType":"address","indexed":true}],"anonymous":false},{"type":"event","name":"SignalEvent","inputs":[{"type":"uint256","name":"session","internalType":"uint256","indexed":true},{"type":"uint8","name":"sequence","internalType":"uint8","indexed":true},{"type":"uint8","name":"actionId","internalType":"uint8","indexed":true},{"type":"uint8","name":"role","internalType":"uint8","indexed":false},{"type":"uint256","name":"when","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"function","stateMutability":"view","outputs":[{"type":"bytes32","name":"","internalType":"bytes32"}],"name":"DEFAULT_ADMIN_ROLE","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"O00","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"O01","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"O02","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"O10","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"O11","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"O12","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"O20","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"O21","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"O22","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"bytes32","name":"","internalType":"bytes32"}],"name":"PLAYER_O","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"bytes32","name":"","internalType":"bytes32"}],"name":"PLAYER_X","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"X00","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"X01","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"X02","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"X10","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"X11","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"X12","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"X20","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"X21","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"X22","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint8","name":"","internalType":"enum TicTacToeModel.Roles"}],"name":"getRole","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"bytes32","name":"","internalType":"bytes32"}],"name":"getRoleAdmin","inputs":[{"type":"bytes32","name":"role","internalType":"bytes32"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"grantRole","inputs":[{"type":"bytes32","name":"role","internalType":"bytes32"},{"type":"address","name":"account","internalType":"address"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"bool","name":"","internalType":"bool"}],"name":"hasRole","inputs":[{"type":"bytes32","name":"role","internalType":"bytes32"},{"type":"address","name":"account","internalType":"address"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"string","name":"","internalType":"string"}],"name":"metamodelUri","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Uint8Model.PetriNet","components":[{"type":"tuple[]","name":"places","internalType":"struct Uint8Model.Place[]","components":[{"type":"uint8","name":"offset","internalType":"uint8"},{"type":"int8","name":"initial","internalType":"int8"},{"type":"int8","name":"capacity","internalType":"int8"}]},{"type":"tuple[]","name":"transitions","internalType":"struct Uint8Model.Transition[]","components":[{"type":"uint8","name":"offset","internalType":"uint8"},{"type":"uint8","name":"role","internalType":"uint8"},{"type":"int8[]","name":"delta","internalType":"int8[]"},{"type":"int8[]","name":"guard","internalType":"int8[]"}]}]}],"name":"model","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"pause","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"renounceRole","inputs":[{"type":"bytes32","name":"role","internalType":"bytes32"},{"type":"address","name":"account","internalType":"address"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"reset","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"revokeRole","inputs":[{"type":"bytes32","name":"role","internalType":"bytes32"},{"type":"address","name":"account","internalType":"address"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"int8","name":"","internalType":"int8"}],"name":"state","inputs":[{"type":"uint256","name":"","internalType":"uint256"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"bool","name":"","internalType":"bool"}],"name":"supportsInterface","inputs":[{"type":"bytes4","name":"interfaceId","internalType":"bytes4"}]},{"type":"function","stateMutability":"view","outputs":[],"name":"testIsGameOpen","inputs":[]},{"type":"function","stateMutability":"view","outputs":[],"name":"testIsMyTurn","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"unpause","inputs":[]}]
}
    function showElement(elementId) {
        document.getElementById(elementId).setAttribute("visibility", "visible")
    }

    // deployed https://sepolia-blockscout.scroll.io/address/0x2A9862692E1d681dA5986B4C96D582dD0Ef29433/contracts#address-tabs
    addr = '0x2A9862692E1d681dA5986B4C96D582dD0Ef29433'

    const ctl = Control("tictactoe", model.tictactoe)
        .subscribe((event) => {
            console.log("frame_" + event.seq, event)
            showElement(event.action)
            if (event.game.over && event.game.winner) {
                showElement(event.game.winner.winSet)
            }
            if (window.walletAddress) {
                contract.methods[event.action]()
                    .send({ from: walletAddress })
                    .then((sent) => console.log({sent}))
            }
        })

    /* To connect using MetaMask */
    async function connect() {
        if (window.ethereum) {
            await window.ethereum.request({method: "eth_requestAccounts"});
            window.web3 = new Web3(window.ethereum);
            const account = web3.eth.accounts;
            //Get the current MetaMask selected/active wallet
            window.walletAddress = account.givenProvider.selectedAddress;
            console.log(`Wallet: ${walletAddress}`);
            ctl.load(); // binds Dapp events to html
            window.contract = new web3.eth.Contract( getABI(), addr)
            window.model = getModel();
            setTimeout(subscribeToEvents, 0) // start the Dapp
        } else {
            console.log("No wallet");
        }
    }

    function assertConnected() {
        if (!window.contract) {
            throw new Error("not connected")
        }
    }

    async function subscribeToEvents() {
    }

    const boardMap = {
        '00': 0,
        '01': 1,
        '02': 2,
        '10': 3,
        '11': 4,
        '12': 5,
        '20': 6,
        '21': 7,
        '22': 8,
    }

    async function getModel() {
        // REVIEW: ideally we would be able to infer the model definition from this response
        // this front end library does not do that yet - it would also have to infer the visual layout
        const { places, transitions } = await contract.methods.model().call();

        async function getState(n)  {
            const s = await contract.methods.state(boardMap[n]).call();
            return parseInt(s)
        }

        const state = {}
        for (const label of Object.keys(boardMap)) {
            state[label] = await getState(label)
        }

        let role = '?'
        try {
            role =  await contract.methods.getRole().call(); // REVIEW: is it OK to use call here?
        } catch {
        }
        console.log({model: { places, transitions}, role, state}, 'getModel')
    }

    async function resetGame() {
        if (window.contract) {
            console.log('resettingGame');
            await contract.methods.reset().send({ from: walletAddress });
        } else {
            console.log('Wallet not connected');
        }
    }

</script>
<input onclick="resetGame();" type="button" value="Reset Game">
<input onclick="connect();" type="button" value="Connect Wallet">
<br/>
<svg height="500" id="board" width="500">
    <rect fill="#ffffff" height="100" id="00" stroke="#000000" width="100" x="100" y="100"/>
    <rect fill="#ffffff" height="100" id="01" stroke="#000000" width="100" x="200" y="100"/>
    <rect fill="#ffffff" height="100" id="02" stroke="#000000" width="100" x="300" y="100"/>

    <rect fill="#ffffff" height="100" id="10" stroke="#000000" width="100" x="100" y="200"/>
    <rect fill="#ffffff" height="100" id="11" stroke="#000000" width="100" x="200" y="200"/>
    <rect fill="#ffffff" height="100" id="12" stroke="#000000" width="100" x="300" y="200"/>

    <rect fill="#ffffff" height="100" id="20" stroke="#000000" width="100" x="100" y="300"/>
    <rect fill="#ffffff" height="100" id="21" stroke="#000000" width="100" x="200" y="300"/>
    <rect fill="#ffffff" height="100" id="22" stroke="#000000" width="100" x="300" y="300"/>

    <text font-size="5em" id="O00" visibility="hidden" x="122" y="175">O</text>
    <text font-size="5em" id="O01" visibility="hidden" x="222" y="175">O</text>
    <text font-size="5em" id="O02" visibility="hidden" x="322" y="175">O</text>

    <text font-size="5em" id="X00" visibility="hidden" x="122" y="175">X</text>
    <text font-size="5em" id="X01" visibility="hidden" x="222" y="175">X</text>
    <text font-size="5em" id="X02" visibility="hidden" x="322" y="175">X</text>

    <text font-size="5em" id="O10" visibility="hidden" x="122" y="275">O</text>
    <text font-size="5em" id="O11" visibility="hidden" x="222" y="275">O</text>
    <text font-size="5em" id="O12" visibility="hidden" x="322" y="275">O</text>

    <text font-size="5em" id="X10" visibility="hidden" x="122" y="275">X</text>
    <text font-size="5em" id="X11" visibility="hidden" x="222" y="275">X</text>
    <text font-size="5em" id="X12" visibility="hidden" x="322" y="275">X</text>

    <text font-size="5em" id="O20" visibility="hidden" x="122" y="375">O</text>
    <text font-size="5em" id="O21" visibility="hidden" x="222" y="375">O</text>
    <text font-size="5em" id="O22" visibility="hidden" x="322" y="375">O</text>

    <text font-size="5em" id="X20" visibility="hidden" x="122" y="375">X</text>
    <text font-size="5em" id="X21" visibility="hidden" x="222" y="375">X</text>
    <text font-size="5em" id="X22" visibility="hidden" x="322" y="375">X</text>

    <line id="win-0" stroke="#000000" stroke-width="4px" visibility="hidden" x1="125" x2="375" y1="150" y2="150"></line>
    <line id="win-1" stroke="#000000" stroke-width="4px" visibility="hidden" x1="125" x2="375" y1="250" y2="250"></line>
    <line id="win-2" stroke="#000000" stroke-width="4px" visibility="hidden" x1="125" x2="375" y1="350" y2="350"></line>

    <line id="win-3" stroke="#000000" stroke-width="4px" visibility="hidden" x1="150" x2="150" y1="375" y2="125"></line>
    <line id="win-4" stroke="#000000" stroke-width="4px" visibility="hidden" x1="250" x2="250" y1="375" y2="125"></line>
    <line id="win-5" stroke="#000000" stroke-width="4px" visibility="hidden" x1="350" x2="350" y1="375" y2="125"></line>

    <line id="win-6" stroke="#000000" stroke-width="4px" visibility="hidden" x1="125" x2="375" y1="125" y2="375"></line>
    <line id="win-7" stroke="#000000" stroke-width="4px" visibility="hidden" x1="125" x2="375" y1="375" y2="125"></line>

</svg>
</body>
</html>
